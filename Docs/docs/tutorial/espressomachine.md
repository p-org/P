??? note "How to use this example"

    We assume that you have cloned the P repository locally.
    ```shell 
    git clone https://github.com/p-org/P.git
    ```

    The recommended way to work through this example is to open the [P\Tutorial](https://github.com/p-org/P/tree/master/Tutorial) folder in IntelliJ side-by-side a browser using which you can simulatenously read the description for each example and browser the P program in IntelliJ. 

We have reached the middle of our tutorials :yawning_face:, its time to take a break and have an espresso coffee! :coffee:

P has been used in the past to implement device drivers and robotics systems (see [case studies](../casestudies.md) and [publications](../publications.md#p-case-studies)). One of the many challenges in implementing such systems is that they are reactive systems and hence, must handle various sequence of events (inputs) appropriately depending on its current mode of operation.

**System:** We consider a fun example of modeling an espresso coffee machine and see how we can use P state machines to model a reactive system that must respond correctly to various user inputs.
The user interacts with the coffee machine through its control panel.

![Placeholder](espressomachine.png){ width=50% align=center }

The control panel presents an interface to the user to perform operations like `reset` machine, turn `steamer` on and off, request an `espresso`, and clear the `grounds` by opening the container. The control panel interprets these inputs from the user and sends appropriate commands to the coffee maker. We demonstrate how using P state machine, one can capture the required reactive behavior control panel and define how it must handle different user inputs.

**Correctness Specifications:**
P checker by default checks that every event that is received in any state has a handler defined for it, otherwise, it results in an unhandled event exception. If the P checker passes then it implies that the system model can handle any sequence of events generated by the given environment which in our example's context implies that the coffee machine control panel can correctly handle any sequence of inputs (or button presses) by the user. We would also like to check that the coffee machine moves through a desired sequence of states, i.e., `reset -> warm-up -> make_espresso -> grind coffee -> run_espresso -> *`.

<!---

### P Project

The [1_ClientServer](https://github.com/p-org/P/tree/master/Tutorial/1_ClientServer) folder contains the source code for the [ClientServer](https://github.com/p-org/P/blob/master/Tutorial/1_ClientServer/ClientServer.pproj) project. Please feel free to read details about the typical [P program structure](../advanced/structureOfPProgram.md) and [P project file](../advanced/PProject.md).

### Models

The P models ([PSrc](https://github.com/p-org/P/tree/master/Tutorial/1_ClientServer/PSrc)) for the ClientServer example consists of four files: 

1. [Client.p](https://github.com/p-org/P/blob/master/Tutorial/1_ClientServer/PSrc/Client.p): Implements the Client state machine.
  
??? tip "[Expand]: Lets walk through Client.p"
    ...

- [Server.p](https://github.com/p-org/P/blob/master/Tutorial/1_ClientServer/PSrc/Server.p): Implements the BankServer state machine.
  
??? tip "[Expand]: Lets walk through Server.p"
    ...

- [AbstractBankServer.p](https://github.com/p-org/P/blob/master/Tutorial/1_ClientServer/PSrc/AbstractBankServer.p): Implements the AbstractBankServer state machine that provides an simplified abstraction for the BankServer machine.

??? tip "[Expand]: Lets walk through AbstractBankServer.p"
    ...

- [ClientServerModules.p](https://github.com/p-org/P/blob/master/Tutorial/1_ClientServer/PSrc/ClientServerModules.p): Declares the P modules corresponding to each component in the system.

??? tip "[Expand]: Lets walk through ClientServerModules.p"
    ...

### Specifications

The P Specifications ([PSpec](https://github.com/p-org/P/blob/master/Tutorial/1_ClientServer/PSpec)) for the ClientServer example are implemented in the [BankBalanceCorrect.p](https://github.com/p-org/P/blob/master/Tutorial/1_ClientServer/PSpec/BankBalanceCorrect.p) file. We define two specifications:

- BankBalanceIsAlwaysCorrect (safety property): BankBalanceIsCorrect checks the global invariant that the account-balance communicated to the client by the bank is always correct and the banks never removes more money from the account than that withdrawn by the client! Also, if the bank denies a withdraw request then its only because the withdrawal will reduce the account balance to below 10.

- GuaranteedWithDrawProgress (liveness property): GuaranteedWithDrawProgress checks the liveness (or progress) property that all withdraw requests submitted by the client are eventually responded.

!!! info "Note" 
    BankBalanceIsCorrect also checks that if there is enough money in the account then the withdraw request must not error. Hence, the two properties above together ensure that every withdraw request if allowed will eventually succeed and the bank cannot block correct withdrawal requests.

??? tip "[Expand]: Lets walk through BankBalanceCorrect.p"
    ...

### Test Scenarios

The test scenarios folder in P consists of two parts: (1) TestDrivers: These are collection of state machines that implement the test harnesses or environment state machines for different test scenarios and (2) TestScripts: These are collection of test cases that are automatically discharged by the P checker.

The test scenarios folder for ClientServer ([PTst](https://github.com/p-org/P/tree/master/Tutorial/1_ClientServer/PTst)) consists of two files [TestDriver.p](https://github.com/p-org/P/blob/master/Tutorial/1_ClientServer/PTst/TestDriver.p) and [TestScript.p](https://github.com/p-org/P/blob/master/Tutorial/1_ClientServer/PTst/Testscript.p).

??? tip "[Expand]: Lets walk through TestDriver.p"
    ...

??? tip "[Expand]: Lets walk through TestScript.p"
    ...

### Compiling ClientServer

### Testing ClientServer

### Exercise Problem

!!! summary "Summary"
    This is a just for fun example to demonstrate how to model a reactive system as a P state machine. We also show how using P monitors we can check that the system moves through the correct modes of operation.

--->
